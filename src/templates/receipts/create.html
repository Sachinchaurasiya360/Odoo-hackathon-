{% extends "base.html" %} {% block title %}Create Receipt - Inventory
Management{% endblock %} {% block breadcrumb %}
<span class="breadcrumb-item">Operations</span>
<i class="bi bi-chevron-right"></i>
<a href="{{ url_for('receipts.list_receipts') }}" class="breadcrumb-item"
  >Receipts</a
>
<i class="bi bi-chevron-right"></i>
<span class="breadcrumb-item">Create</span>
{% endblock %} {% block content %}
<div class="page-header">
  <div class="page-header-content">
    <h1 class="page-title">
      <i class="bi bi-plus-circle gradient-text"></i>
      Create Receipt
    </h1>
    <p class="page-description">Record incoming inventory from supplier</p>
  </div>
</div>

<form
  method="POST"
  action="{{ url_for('receipts.create_receipt') }}"
  class="needs-validation"
  novalidate
>
  <!-- CSRF Protection -->
  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />

  <div class="row g-4">
    <!-- Main Form -->
    <div class="col-lg-8">
      <!-- Receipt Details -->
      <div class="card elevation-3 mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-file-earmark text-primary"></i>
            Receipt Details
          </h5>
        </div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-6">
              <label for="warehouse_id" class="form-label fw-semibold">
                <i class="bi bi-building text-primary"></i>
                Warehouse <span class="text-danger">*</span>
              </label>
              <select
                class="form-select"
                id="warehouse_id"
                name="warehouse_id"
                required
              >
                <option value="">Select Warehouse</option>
                {% for warehouse in warehouses %}
                <option value="{{ warehouse._id }}">
                  {{ warehouse.name }}
                </option>
                {% endfor %}
              </select>
              <div class="invalid-feedback">Please select a warehouse</div>
            </div>

            <div class="col-md-6">
              <label for="supplier_name" class="form-label fw-semibold">
                <i class="bi bi-truck text-primary"></i>
                Supplier Name <span class="text-danger">*</span>
              </label>
              <input
                type="text"
                class="form-control"
                id="supplier_name"
                name="supplier_name"
                required
              />
              <div class="invalid-feedback">Please enter supplier name</div>
            </div>

            <div class="col-md-6">
              <label for="scheduled_date" class="form-label fw-semibold">
                <i class="bi bi-calendar text-primary"></i>
                Scheduled Date
              </label>
              <input
                type="date"
                class="form-control"
                id="scheduled_date"
                name="scheduled_date"
                value="{{ today }}"
              />
            </div>

            <div class="col-12">
              <label for="notes" class="form-label fw-semibold">
                <i class="bi bi-sticky text-primary"></i>
                Notes
              </label>
              <textarea
                class="form-control"
                id="notes"
                name="notes"
                rows="3"
                placeholder="Additional notes..."
              ></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Items -->
      <div class="card elevation-3">
        <div
          class="card-header d-flex justify-content-between align-items-center"
        >
          <h5 class="card-title mb-0">
            <i class="bi bi-list-check text-primary"></i>
            Items
          </h5>
          <button
            type="button"
            class="btn btn-sm btn-outline-primary hover-scale"
            onclick="addItemRow()"
          >
            <i class="bi bi-plus-lg"></i> Add Item
          </button>
        </div>
        <div class="card-body p-0">
          <div class="table-responsive">
            <table class="table table-borderless mb-0" id="itemsTable">
              <thead class="table-light">
                <tr>
                  <th style="width: 40%">Product</th>
                  <th style="width: 20%">Expected Qty</th>
                  <th style="width: 20%">Unit Price</th>
                  <th style="width: 15%">Total</th>
                  <th style="width: 5%"></th>
                </tr>
              </thead>
              <tbody id="itemsTableBody">
                <!-- Items will be added here -->
              </tbody>
              <tfoot class="table-light">
                <tr>
                  <td colspan="3" class="text-end fw-bold">Total:</td>
                  <td class="fw-bold" id="grandTotal">$0.00</td>
                  <td></td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>

      <input type="hidden" name="item_count" id="item_count" value="0" />
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <div class="card elevation-3 sticky-top" style="top: 80px">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="bi bi-lightning text-primary"></i>
            Actions
          </h5>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary hover-scale">
              <i class="bi bi-check-lg"></i> Create Receipt
            </button>
            <a
              href="{{ url_for('receipts.list_receipts') }}"
              class="btn btn-outline-secondary hover-lift"
            >
              <i class="bi bi-x-lg"></i> Cancel
            </a>
          </div>

          <hr class="my-4" />

          <div class="alert alert-info mb-0">
            <i class="bi bi-info-circle"></i>
            <strong>Workflow:</strong>
            <ol class="mb-0 mt-2 ps-3">
              <li>Draft (editable)</li>
              <li>Waiting (confirmed)</li>
              <li>Ready (items prepared)</li>
              <li>Done (stock updated)</li>
            </ol>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Item Row Template -->
<template id="itemRowTemplate">
  <tr class="item-row">
    <td>
      <select
        class="form-select form-select-sm"
        name="items[0][product_id]"
        required
      >
        <option value="">Select Product</option>
        {% for product in products %}
        <option value="{{ product._id }}">
          {{ product.name }} ({{ product.sku }})
        </option>
        {% endfor %}
      </select>
    </td>
    <td>
      <input
        type="number"
        class="form-control form-control-sm item-qty"
        name="items[0][expected_quantity]"
        min="0.01"
        step="0.01"
        required
        onchange="calculateRowTotal(this)"
      />
    </td>
    <td>
      <input
        type="number"
        class="form-control form-control-sm item-price"
        name="items[0][unit_price]"
        min="0"
        step="0.01"
        required
        onchange="calculateRowTotal(this)"
      />
    </td>
    <td>
      <span class="item-total">$0.00</span>
    </td>
    <td>
      <button
        type="button"
        class="btn btn-sm btn-outline-danger"
        onclick="removeItemRow(this)"
        title="Remove"
      >
        <i class="bi bi-trash"></i>
      </button>
    </td>
  </tr>
</template>
{% endblock %} {% block extra_js %}
<script>
  let itemIndex = 0;

  function addItemRow() {
    const template = document.getElementById("itemRowTemplate");
    const tbody = document.getElementById("itemsTableBody");
    const clone = template.content.cloneNode(true);

    // Update indices
    clone.querySelectorAll("[name]").forEach((input) => {
      const name = input.getAttribute("name");
      input.setAttribute("name", name.replace("[0]", `[${itemIndex}]`));
    });

    tbody.appendChild(clone);
    itemIndex++;
    document.getElementById("item_count").value = itemIndex;
  }

  function removeItemRow(button) {
    button.closest("tr").remove();
    calculateGrandTotal();
  }

  function calculateRowTotal(input) {
    const row = input.closest("tr");
    const qty = parseFloat(row.querySelector(".item-qty").value) || 0;
    const price = parseFloat(row.querySelector(".item-price").value) || 0;
    const total = qty * price;

    row.querySelector(".item-total").textContent = "$" + total.toFixed(2);
    calculateGrandTotal();
  }

  function calculateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll(".item-total").forEach((span) => {
      const value = parseFloat(span.textContent.replace("$", "")) || 0;
      grandTotal += value;
    });

    document.getElementById("grandTotal").textContent =
      "$" + grandTotal.toFixed(2);
  }

  // Add first row on page load
  document.addEventListener("DOMContentLoaded", function () {
    addItemRow();
  });
</script>
{% endblock %}
