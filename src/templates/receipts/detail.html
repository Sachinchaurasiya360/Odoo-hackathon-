{% extends "base.html" %}

{% block title %}Receipt {{ receipt.receipt_number }} - Inventory Management{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item">Operations</span>
<i class="bi bi-chevron-right"></i>
<a href="{{ url_for('receipts.list_receipts') }}" class="breadcrumb-item">Receipts</a>
<i class="bi bi-chevron-right"></i>
<span class="breadcrumb-item">{{ receipt.receipt_number }}</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="bi bi-file-earmark-text"></i>
            Receipt {{ receipt.receipt_number }}
        </h1>
        <div class="mt-2">
            <span class="badge bg-{{ receipt.status|status_badge }} fs-6">
                {{ receipt.status|upper }}
            </span>
        </div>
    </div>
    <div class="page-actions">
        {% if receipt.status in ['draft', 'waiting', 'ready'] %}
        <form method="POST" action="{{ url_for('receipts.transition_receipt', receipt_id=receipt._id) }}"
            class="d-inline">
            <input type="hidden" name="new_status" value="{{ next_status }}">
            <button type="submit" class="btn btn-success">
                <i class="bi bi-arrow-right-circle"></i>
                Move to {{ next_status|upper }}
            </button>
        </form>
        {% endif %}
        {% if receipt.status == 'draft' %}
        <a href="{{ url_for('receipts.edit_receipt', receipt_id=receipt._id) }}" class="btn btn-outline-primary">
            <i class="bi bi-pencil"></i> Edit
        </a>
        {% endif %}
    </div>
</div>

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <!-- Receipt Information -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Receipt Information</h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-6">
                        <label class="text-muted small">Receipt Number</label>
                        <div class="fw-semibold">{{ receipt.receipt_number }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Supplier</label>
                        <div class="fw-semibold">{{ receipt.supplier_name }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Warehouse</label>
                        <div class="fw-semibold">{{ receipt.warehouse_name or receipt.warehouse_id }}</div>
                    </div>
                    <div class="col-md-6">
                        <label class="text-muted small">Scheduled Date</label>
                        <div class="fw-semibold">{{ receipt.scheduled_date|date_format }}</div>
                    </div>
                    {% if receipt.received_date %}
                    <div class="col-md-6">
                        <label class="text-muted small">Received Date</label>
                        <div class="fw-semibold">{{ receipt.received_date|datetime_format }}</div>
                    </div>
                    {% endif %}
                    {% if receipt.notes %}
                    <div class="col-12">
                        <label class="text-muted small">Notes</label>
                        <div>{{ receipt.notes }}</div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Items -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Items</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Product</th>
                                <th class="text-end">Expected Qty</th>
                                <th class="text-end">Received Qty</th>
                                <th class="text-end">Damaged Qty</th>
                                <th class="text-end">Unit Price</th>
                                <th class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in receipt.items %}
                            <tr>
                                <td>
                                    <div class="fw-semibold">{{ item.product_name or item.product_id }}</div>
                                    <small class="text-muted">{{ item.product_sku }}</small>
                                </td>
                                <td class="text-end">{{ item.expected_quantity|number_format }}</td>
                                <td class="text-end">
                                    {% if receipt.status == 'done' %}
                                    <span class="badge bg-success">{{ item.received_quantity|number_format }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">
                                    {% if item.damaged_quantity > 0 %}
                                    <span class="badge bg-danger">{{ item.damaged_quantity|number_format }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-end">${{ item.unit_price|number_format }}</td>
                                <td class="text-end fw-semibold">
                                    ${{ (item.expected_quantity * item.unit_price)|number_format }}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot class="table-light">
                            <tr>
                                <td colspan="5" class="text-end fw-bold">Total:</td>
                                <td class="text-end fw-bold">
                                    ${{ total_amount|number_format }}
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Status History -->
        {% if receipt.status_history %}
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Status History</h5>
            </div>
            <div class="card-body">
                <div class="timeline">
                    {% for history in receipt.status_history %}
                    <div class="timeline-item">
                        <div class="timeline-marker bg-{{ history.status|status_badge }}"></div>
                        <div class="timeline-content">
                            <div class="fw-semibold">{{ history.status|upper }}</div>
                            <small class="text-muted">
                                {{ history.changed_at|datetime_format }}
                                by {{ history.changed_by_name or history.changed_by }}
                            </small>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Workflow Progress -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Workflow Progress</h5>
            </div>
            <div class="card-body">
                <div class="workflow-steps">
                    <div
                        class="workflow-step {% if receipt.status in ['draft', 'waiting', 'ready', 'done'] %}completed{% endif %}">
                        <div class="step-marker">1</div>
                        <div class="step-label">Draft</div>
                    </div>
                    <div
                        class="workflow-step {% if receipt.status in ['waiting', 'ready', 'done'] %}completed{% endif %}">
                        <div class="step-marker">2</div>
                        <div class="step-label">Waiting</div>
                    </div>
                    <div class="workflow-step {% if receipt.status in ['ready', 'done'] %}completed{% endif %}">
                        <div class="step-marker">3</div>
                        <div class="step-label">Ready</div>
                    </div>
                    <div class="workflow-step {% if receipt.status == 'done' %}completed{% endif %}">
                        <div class="step-marker">4</div>
                        <div class="step-label">Done</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Metadata -->
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Metadata</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <label class="text-muted small">Created By</label>
                    <div>{{ receipt.created_by_name or receipt.created_by }}</div>
                </div>
                <div class="mb-3">
                    <label class="text-muted small">Created At</label>
                    <div>{{ receipt.created_at|datetime_format }}</div>
                </div>
                <div>
                    <label class="text-muted small">Last Updated</label>
                    <div>{{ receipt.updated_at|datetime_format }}</div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
    .timeline {
        position: relative;
        padding-left: 2rem;
    }

    .timeline-item {
        position: relative;
        padding-bottom: 1.5rem;
    }

    .timeline-item:not(:last-child)::before {
        content: '';
        position: absolute;
        left: -1.5rem;
        top: 1.5rem;
        bottom: -0.5rem;
        width: 2px;
        background: #e2e8f0;
    }

    .timeline-marker {
        position: absolute;
        left: -1.75rem;
        top: 0.25rem;
        width: 0.75rem;
        height: 0.75rem;
        border-radius: 50%;
    }

    .workflow-steps {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .workflow-step {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        padding: 0.75rem;
        border-radius: 0.375rem;
        background: #f8fafc;
    }

    .workflow-step.completed {
        background: #dcfce7;
    }

    .step-marker {
        width: 2rem;
        height: 2rem;
        border-radius: 50%;
        background: #cbd5e1;
        color: #fff;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 600;
        font-size: 0.875rem;
    }

    .workflow-step.completed .step-marker {
        background: #22c55e;
    }

    .step-label {
        font-weight: 500;
    }
</style>
{% endblock %}