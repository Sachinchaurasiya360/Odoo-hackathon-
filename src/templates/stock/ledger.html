{% extends "base.html" %}
{% from "components/table.html" import render_table, render_pagination %}

{% block title %}Stock Ledger - Inventory Management{% endblock %}

{% block breadcrumb %}
<span class="breadcrumb-item">Reports</span>
<i class="bi bi-chevron-right"></i>
<span class="breadcrumb-item">Stock Ledger</span>
{% endblock %}

{% block content %}
<div class="page-header">
    <div class="page-header-content">
        <h1 class="page-title">
            <i class="bi bi-clock-history"></i>
            Stock Ledger
        </h1>
        <p class="page-description">Complete audit trail of all stock movements</p>
    </div>
    <div class="page-actions">
        <button class="btn btn-outline-primary" onclick="exportLedger()">
            <i class="bi bi-download"></i> Export
        </button>
    </div>
</div>

<!-- Filters -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label for="product" class="form-label">Product</label>
                <select class="form-select" id="product" name="product_id">
                    <option value="">All Products</option>
                    {% for product in products %}
                    <option value="{{ product._id }}" {% if request.args.get('product_id')==product._id|string
                        %}selected{% endif %}>
                        {{ product.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-3">
                <label for="warehouse" class="form-label">Warehouse</label>
                <select class="form-select" id="warehouse" name="warehouse_id">
                    <option value="">All Warehouses</option>
                    {% for warehouse in warehouses %}
                    <option value="{{ warehouse._id }}" {% if request.args.get('warehouse_id')==warehouse._id|string
                        %}selected{% endif %}>
                        {{ warehouse.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="col-md-2">
                <label for="transaction_type" class="form-label">Transaction Type</label>
                <select class="form-select" id="transaction_type" name="transaction_type">
                    <option value="">All Types</option>
                    <option value="receipt" {% if request.args.get('transaction_type')=='receipt' %}selected{% endif %}>
                        Receipt</option>
                    <option value="delivery" {% if request.args.get('transaction_type')=='delivery' %}selected{% endif
                        %}>Delivery</option>
                    <option value="transfer_in" {% if request.args.get('transaction_type')=='transfer_in' %}selected{%
                        endif %}>Transfer In</option>
                    <option value="transfer_out" {% if request.args.get('transaction_type')=='transfer_out' %}selected{%
                        endif %}>Transfer Out</option>
                    <option value="adjustment" {% if request.args.get('transaction_type')=='adjustment' %}selected{%
                        endif %}>Adjustment</option>
                </select>
            </div>

            <div class="col-md-2">
                <label for="date_from" class="form-label">Date From</label>
                <input type="date" class="form-control" id="date_from" name="date_from"
                    value="{{ request.args.get('date_from', '') }}">
            </div>

            <div class="col-md-2">
                <label for="date_to" class="form-label">Date To</label>
                <input type="date" class="form-control" id="date_to" name="date_to"
                    value="{{ request.args.get('date_to', '') }}">
            </div>

            <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-secondary">
                    <i class="bi bi-funnel"></i> Filter
                </button>
                <a href="{{ url_for('stock.view_ledger') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-x-lg"></i> Clear
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Ledger Table -->
<div class="card">
    <div class="card-header">
        <h5 class="card-title mb-0">Transaction History</h5>
    </div>
    {% call render_table(['Date', 'Product', 'Warehouse', 'Type', 'Reference', 'Qty Change', 'Balance', 'User'],
    ledger_entries, actions=False) %}
    {% for entry in ledger_entries %}
    <tr>
        <td>{{ entry.transaction_date|datetime_format }}</td>
        <td>
            <div class="fw-semibold">{{ entry.product_name or entry.product_id }}</div>
            <small class="text-muted">{{ entry.product_sku }}</small>
        </td>
        <td>{{ entry.warehouse_name or entry.warehouse_id }}</td>
        <td>
            <span class="badge bg-{{ entry.transaction_type|status_badge }}">
                {{ entry.transaction_type|upper }}
            </span>
        </td>
        <td>
            <a href="{{ entry.reference_url }}" class="text-decoration-none">
                {{ entry.reference_number }}
            </a>
            <br>
            <small class="text-muted">{{ entry.reference_type }}</small>
        </td>
        <td class="text-end">
            <span class="{% if entry.quantity_change > 0 %}text-success{% else %}text-danger{% endif %} fw-semibold">
                {% if entry.quantity_change > 0 %}+{% endif %}{{ entry.quantity_change|number_format }}
            </span>
        </td>
        <td class="text-end fw-semibold">
            {{ entry.quantity_after|number_format }}
        </td>
        <td>{{ entry.created_by_name or entry.created_by }}</td>
    </tr>
    {% endfor %}
    {% endcall %}

    {{ render_pagination(pagination) }}
</div>
{% endblock %}

{% block extra_js %}
<script>
    function exportLedger() {
        // Get current filters
        const params = new URLSearchParams(window.location.search);
        params.set('export', 'csv');

        // Download CSV
        window.location.href = '{{ url_for("stock.view_ledger") }}?' + params.toString();
    }
</script>
{% endblock %}